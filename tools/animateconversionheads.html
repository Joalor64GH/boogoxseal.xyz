<!DOCTYPE html>
<html lang="en" style="background-color:rgb(17, 5, 29) ;">
<head>
	<title>Adobe Animate to Incredibox Converter - BOOGO x SEAL</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="Boogo and Seal make Incredibox Mods and Tools.">
	<link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
	<link rel="manifest" href="../icons/site.webmanifest">
	<link rel="shortcut icon" href="../icons/favicon.ico">
	<meta name="msapplication-TileColor" content="#603cba">
	<meta name="msapplication-config" content="../icons/browserconfig.xml">
	<meta name="theme-color" content="#ffffff">
	<meta charset="UTF-8">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="BOOGO x SEAL">
	<meta property="og:title" content="Adobe Animate to Incredibox Converter" />
	    <meta property="og:image" content="https://boogoxseal.xyz/assets/banner.png" />
    <meta property="twitter:image:src" content="https://boogoxseal.xyz/assets/banner.png" />
	<meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:description" content="Boogo and Seal make Incredibox Mods and Tools.">
    <meta name="og:image:alt" content="Boogo and Seal make Incredibox Mods and Tools.">
    <meta name="og:description" content="Boogo and Seal make Incredibox Mods and Tools.">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/6.0.1/mdb.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/topnav.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="../assets/canvas-funcs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        td{text-align:center}.th-custom{overflow:auto;font-weight:200;text-align:center;padding-left:5px;padding-right:5px;font-size:28px;margin:10px}body{-webkit-touch-callout:none;-webkit-user-select:none;-khtml-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;color:#fff;overflow:auto;font-family:monospace;font-weight:500;margin-top:15vh}
    </style>
</head>



<body style="background-color:rgb(17, 5, 29) ;">
    <div class="topnav">
		<a href="../">Home</a>
		<a class="active" href="./">Tools</a>
		<a href="../mods">Mods</a>
		<a href="../about">About Us</a>
		<a href="https://sealldeveloper.github.io/incredibox-downloads-index/">Mod Index</a>
	  </div>
	<div class="container mt-3" style="background-color:rgb(29, 8, 49) ; overflow:hidden;	padding-bottom:40px;height:100%;" >
		<h1 class="m-4 mt-3">Adobe Animate to Incredibox Converter - Heads</h1>
        <small class="m-4" style="color:#fac769">WARNING: This tool was designed to work on <b>Firefox</b> so errors on Chromium based browsers are expected.</small>
        <div id="form">
            <h3 class="m-3">Options</h3>
            <div class="form-group col-md-5 m-4">
                <label for="spritesheet">Spritesheet</label>
                <input class="form-control" type="file" id="spritesheet" required="true" accept="image/png"></input>
            </div>
            <div class="form-group col-md-5 m-4">
                <label for="spritesheetq">Is the spritesheet in HD or Non-HD Format?</label>
                <select id="spritesheetq" class="form-control form-select" required="true">
                    <optgroup>
                        <option value="hd">HD</option>
                        <option value="non-hd" selected="">Non-HD</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group col-md-5 m-4">
                <label for="json">JSON</label>
                <input class="form-control" type="file" id="json" required="true" accept="application/json"></input>
            </div>
            <div class="form-group col-md-5 m-4">
                <label for="jsonq">Is the JSON in HD or Non-HD Format?</label>
                <select id="jsonq" class="form-control form-select" required="true">
                    <optgroup>
                        <option value="hd">HD</option>
                        <option value="non-hd" selected="">Non-HD</option>
                    </optgroup>
                </select>
            </div>
            <div class="form-group col-md-5 m-4">
                <label for="motionxml">Motion XML</label>
                <input class="form-control" type="file" id="motionxml" required="true" accept="application/xml,text/xml"></input>
            </div>
            <div class="form-group col-md-5 m-4">
                <label for="downbuffer">Downwards Buffer</label><br>
                <small>Only use this if the head is too high up, this adds a 'buffer' to push the head down (measured in pixels).</small>
                <input class="form-control" type="number" id="downbuffer" placeholder="20"></input>
            </div>
            <div class="form-group m-4 mt-4" id="submit">
                <input class="btn btn-primary" type="submit" value="Submit" id="submission"></input>
            </div>
            <br>
            <hr class="hr hr-blurry" />
            <br>
            <div class="m-4">
                <h3>How to export to Spritesheet, JSON and Motion XML from Adobe Animate?</h3>
                <span>
                    <p style="color:#fac769">NOTE: 'Tweening' seems to effect the motion XML, please refrain from it.</p>
                    <br>
                    1. Select all the moving frames of your head alone, delete the body layer. Then at the top of the window, click 'Commands', then 'Export Motion as XML'.<br><br>
                    2. After exporting the motion, remove all keyframes moving the head from the head layer <b>except the first one</b>, and expand that first one to be the length of the animation. Then, right click on the symbol and select the 'Generate Sprite Sheet...' button.<br><br>
                    3. A menu will appear, the follow settings should be set:<br>
                        - Image Dimensions: Auto size<br>
                        - Image format: PNG 32 bit<br>
                        - Background Color: Transparent<br>
                        - Algorithm: Basic<br>
                        - Data format: JSON<br>
                        - Rotate: Disabled<br>
                        - Trim: Disabled<br>
                        - Stack frames: Enabled<br>
                        - Border padding: 0px<br>
                        - Shape padding: 0px<br><br>
                    4. Press 'Export' ion the bottom right corner of the menu, a PNG and a JSON should be outputted to the output directory.<br><br>
                    This should be all the files required
                </span>
            </div>
            <canvas id="spritesheetcanvas" class="visually-hidden"></canvas>
            <canvas id="fixedspritesheetcanvas" class="visually-hidden"></canvas>
            <div id="jsoncontent" class="visually-hidden"></div>
            <div id="spritesheetcontent" class="visually-hidden"></div>
        </div>
	</div>
    <script>
        seperate_count=0
        function range(start, stop, step) {
            if (typeof stop == 'undefined') {
                // one param defined
                stop = start;
                start = 0;
            }

            if (typeof step == 'undefined') {
                step = 1;
            }

            if ((step > 0 && start >= stop) || (step < 0 && start <= stop)) {
                return [];
            }

            var result = [];
            for (var i = start; step > 0 ? i < stop : i > stop; i += step) {
                result.push(i);
            }

            return result;
        };

        function LoadImageFromDisk(input, callback) {
            try{
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.readAsDataURL(input.files[0]);
                    reader.onload = function (e) {
                        callback(reader.result)
                    };
                } else {
                    console.log('hi img broke')
                }
            } catch (e) {
                console.log(e)
            }
        }

        function LoadJSONFromDisk(input, callback) {
            try{
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.readAsText(input.files[0]);
                    reader.onload = () => {
                        callback(reader.result);
                    };
                }  else {
                    console.log('hi json broke')
                }
            } catch (e) {
                console.log(e)
            }
        }

        function LoadXMLFromDisk(input, callback) {
            try{
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.readAsDataURL(input.files[0]);
                    reader.onload = () => {
                        callback(reader.result);
                    };
                }  else {
                    console.log('hi xml broke')
                }
            } catch (e) {
                console.log(e)
            }
        }

        async function submit() {
            if ( ! window.FileReader ) {
                return alert( 'FileReader API is not supported by your browser.' );
            }
            jsondata=""
            xmldata=""
            $( '#jsoncontent' ).empty()
            $( '#spritesheetcontent' ).empty()
            var $i = $( '#json' ), // Put file input ID here
                inputi = $i[0]; // Getting the element from jQuery
            var $j = $( '#spritesheet' ), // Put file input ID here
                inputj = $j[0]; // Getting the element from jQuery
                var $k = $( '#motionxml' ), // Put file input ID here
                inputk = $k[0]; // Getting the element from jQuery
            var jsoninput = $('#json')[0];
            var imginput = $('#spritesheet')[0];
            var xmlinput = $('#motionxml')[0];
            LoadJSONFromDisk(jsoninput, (text) => {
                jsondata=JSON.parse(text)
            })
            LoadXMLFromDisk(xmlinput, (text) => {
                xmldata=atob(text.split(',')[1])
            })
            LoadImageFromDisk(imginput, (imgdata) => {
                if (window.DOMParser){
                parser = new DOMParser();
                xml = parser.parseFromString(xmldata, "text/xml")
                } else // Internet Explorer
                {
                    xml = new ActiveXObject("Microsoft.XMLDOM");
                    xml.async = false;
                    xml.loadXML(xmldata);
                }
                xmlframes=xml.childNodes[0].childNodes
                validframes=[]
                fc=0
                for (i in Object.keys(xmlframes)) {
                    if (xmlframes[i].attributes && fc != 1) {
                        if (xmlframes[i].attributes['y'] || xmlframes[i].attributes['x']) {
                            validframes.push(xmlframes[i])
                        }
                    }
                    fc++
                }
                
                frame0width = jsondata.frames[Object.keys(jsondata.frames)[0]].sourceSize.w
                frame0height = jsondata.frames[Object.keys(jsondata.frames)[0]].sourceSize.h
                defaultwidth=164
                defaultheight=380

                motion = {}
                for (i in validframes) {
                    x=validframes[i].attributes['x']
                    y=validframes[i].attributes['y']
                    ff=validframes[i].attributes['index']
                    if (Number(ff.nodeValue)){
                        if (x && y) motion[ff.nodeValue] = {"x":x.nodeValue,"y":y.nodeValue}
                        if (!x && y) motion[ff.nodeValue] = {"x":undefined,"y":y.nodeValue}
                        if (x && !y) motion[ff.nodeValue] = {"x":x.nodeValue,"y":undefined}
                        if (!x && !y) motion[ff.nodeValue] = {"x":undefined,"y":undefined}
                    }
                }

                canvas=$('#spritesheetcanvas')[0]
                ctx= canvas.getContext('2d')
                var img = new Image;
                
                img.onload = function(){
                ctx.canvas.width = this.width
                ctx.canvas.height = this.height
                ctx.drawImage(this,0,0); // Or at whatever offset you like
                };
                img.src = imgdata;
                if ($('#spritesheetq').find(':selected').val() === "non-hd" && $('#jsonq').find(':selected').val() === "hd") {
                    frame0width=frame0width/2, frame0height=frame0height/2;
                }
                if ($('#spritesheetq').find(':selected').val() === "hd" && $('#jsonq').find(':selected').val() === "non-hd") {
                    frame0width=frame0width*2, frame0height=frame0height*2;
                }
                final_buffer = Number($('#downbuffer').val())
                newframes=[]
                headcoords=[]
                heads=[]
                prev=[]
                headcount=0
                for (i in Object.keys(jsondata.frames)) {
                    frame=jsondata.frames[Object.keys(jsondata.frames)[i]].frame
                    if (!prev.includes(JSON.stringify(frame))) {
                        headcount++
                        prev.push(JSON.stringify(frame))
                        temphead = canvas.getContext('2d').getImageData(frame.x,frame.y,frame0width,frame0height)
                        headcoords.push({"x":frame.x,"y":frame.y})
                        heads.push(temphead)
                    }
                    newframes.push({"prop":`${frame.x},${frame.y},0,0`})
                }
                count=0
                newcanvas=$('#fixedspritesheetcanvas')[0]
                newctx = newcanvas.getContext('2d')
                newctx.canvas.width = defaultwidth*5
                newctx.canvas.height = defaultheight+(frame0height+final_buffer)*(Math.ceil(headcount/5))

                // Default
                drawLabelledBox(newctx,"red",0,0,defaultwidth,defaultheight,58,defaultheight/2,"Default",15)
                
                // Headless
                drawLabelledBox(newctx,"lime",defaultwidth,0,defaultwidth,defaultheight,55+defaultwidth,defaultheight/2,"Headless",15)
                
                // Siloette
                drawLabelledBox(newctx,"#348af9",defaultwidth*2,0,defaultwidth,defaultheight,48+defaultwidth*2,defaultheight/2,"Silhouette",15)

                // "Watermark"
                newctx.font = "13px CozetteVector";
                newctx.fillText(`sealldeveloper\'s Animate Converter - Heads`,0,12)
                currentx=(defaultwidth-frame0width)/2
                currenty=defaultheight
                modified_indexes=[]
                prev_motion=""
                xm=0
                ym=0
                for (i in range(headcount)) {
                    i=Number(i)
                    count++
                    x = headcoords[i].x
                    y = headcoords[i].y
                    temphead = heads[i]
                    imagedataVal = currenty+(final_buffer*(Math.ceil(count/5)))
                    newcanvas.getContext('2d').putImageData(temphead,currentx,imagedataVal)
                    fc = 0
                    for (f in newframes) {
                        f=newframes[f]
                        if (f.prop == `${x},${y},0,0` && !modified_indexes.includes(fc)) {
                            modified_indexes.push(fc)
                            try{
                                currentclosest=0
                                for (i in Object.keys(motion)) {
                                    i=Object.keys(motion)[i]
                                    currentclosest = (Number(i) <= fc) ? i : currentclosest;
                                }
                                nxm = motion[currentclosest]['x']
                                nym = motion[currentclosest]['y']
                                xm = (xm != nxm && nxm != undefined) ? Number(xym) : xm
                                ym = (ym != nym && nym != undefined) ? Number(nym) : ym
                                xm = xm % 1 != 0 ? Number(xm).toFixed(2) : xm
                                ym = ym % 1 != 0 ? Number(ym).toFixed(2) : ym
                                head_y = currenty+(final_buffer*(Math.ceil(count/5)-1))
                                propval = `${currentx-(defaultwidth-frame0width)/2},${head_y},${xm},${ym}`
                                newframes[fc].prop = propval
                                
                            } catch (e){
                                head_y = currenty+(final_buffer*(Math.ceil(count/5)-1))
                                propval = `${currentx-(defaultwidth-frame0width)/2},${head_y},0,0`
                                newframes[fc].prop = propval
                                console.log(e)
                            }
                            
                        }
                        fc++
                    }
                    currenty += (count%5 === 0) ? frame0height : 0;
                    currentx = (count%5 === 0) ? (defaultwidth-frame0width)/2 : currentx+(defaultwidth-frame0width)+frame0width;
                }
                headHeightVal = frame0height+final_buffer
                newjsondata={"_generated-by-boogoxseal.xyz-tools":"thanks-for-using-them","animeName":"animeName","percentageMax":"0.2","totalFrame":`${newframes.length}`,"width":`${defaultwidth}`,"height":`${defaultheight}`,"headHeight":`${headHeightVal}`,"arrayFrame":newframes}
                if (seperate_count == 2){
                    var zip = new JSZip();
                    zip.file(`generated.json`,JSON.stringify(newjsondata))
                    var datauri = newcanvas.toDataURL('image/png')
                    var data = datauri.replace(/^data:image\/\w+;base64,/, "");
                    zip.file(`generated-sprite.png`, data, {base64:true})
                    zip.generateAsync({type:"base64"}).then(function (base64) {
                        window.open("data:application/zip;base64," + base64);
                    });
                }
                seperate_count++
                return true
            })
        }
        function waitFor(conditionFunction) {

            const poll = resolve => {
                if(conditionFunction()) resolve();
                else setTimeout(_ => poll(resolve), 400);
            }

            return new Promise(poll);
        }

        $('#submission').on('click', async function(){
            seperate_count=0
            seperate_count++
            await submit()
            await waitFor(_ => seperate_count === 2);
            await submit()
            /*$.ajax({
                url: window.location.href,
                headers: {
                    "Pragma": "no-cache",
                    "Expires": -1,
                    "Cache-Control": "no-cache"
                }
            }).done(function () {
                window.location.reload(true);
            });*/
        })
    </script>
    <h3 style="padding-bottom:5px"></h3>
    <h3 style="text-align:center;font-size:10px">Made by <a style="font-size:10px"target="_blank" rel="noopener noreferrer" class="enter">seal</a></h3>
</body>
</html>
